<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - User & Message Management with Ban Control</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 1rem auto;
    padding: 0 1rem;
  }
  h1 {
    text-align: center;
  }
  #loginArea, #adminArea {
    margin-bottom: 2rem;
  }
  #loginArea input, #loginArea button {
    margin: 0.25rem 0;
    padding: 0.5rem;
    font-size: 1rem;
  }
  #adminArea {
    display: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 0.4rem 0.6rem;
    text-align: left;
  }
  th {
    background: #eee;
  }
  button {
    cursor: pointer;
    padding: 0.3rem 0.6rem;
    font-size: 0.9rem;
  }
  .btn-danger {
    color: white;
    background: #d9534f;
    border: none;
  }
  .btn-primary {
    background: #0275d8;
    color: white;
    border: none;
  }
  .btn-secondary {
    background: #5bc0de;
    color: white;
    border: none;
  }
  #userDetails {
    border: 1px solid #ddd;
    padding: 1rem;
    margin-bottom: 2rem;
  }
  label {
    display: block;
    margin-top: 0.5rem;
  }
  input[type=text], input[type=number] {
    width: 100%;
    padding: 0.3rem;
    margin-top: 0.2rem;
  }
  #messageList {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
  }
  #messageList div {
    border-bottom: 1px solid #eee;
    padding: 0.3rem 0.5rem;
  }
  #messageList div span {
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Admin Panel - User & Message Management</h1>

<div id="loginArea">
  <input id="adminEmail" type="email" placeholder="Admin Email" autocomplete="username" />
  <input id="adminPassword" type="password" placeholder="Admin Password" autocomplete="current-password" />
  <button id="adminLoginBtn">Log In as Admin</button>
  <p id="loginStatus"></p>
</div>

<div id="adminArea">
  <button id="adminLogoutBtn" style="float:right;">Log Out</button>
  <h2>Users</h2>
  <table id="usersTable" aria-label="Users Table">
    <thead>
      <tr>
        <th>Email</th>
        <th>UID</th>
        <th>Ban Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="usersTbody"></tbody>
  </table>

  <div id="userDetails" aria-live="polite" aria-atomic="true" hidden>
    <h3>User Details</h3>
    <p><b>Email:</b> <span id="detailEmail"></span></p>
    <p><b>UID:</b> <span id="detailUid"></span></p>
    <p><b>Ban Info:</b> <span id="detailBanInfo"></span></p>

    <h4>Ban User</h4>
    <label for="banDuration">Duration (days):</label>
    <input type="number" id="banDuration" min="1" max="365" value="7" />
    <label for="banReason">Reason:</label>
    <input type="text" id="banReason" placeholder="Enter ban reason" />

    <button id="applyBanBtn" class="btn-primary">Apply Ban</button>
    <button id="removeBanBtn" class="btn-danger">Remove Ban</button>

    <h4>User Messages</h4>
    <div id="messageList"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, get, onValue, remove, query, orderByChild } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  // Replace this config with your Firebase project config
  const firebaseConfig = {
    apiKey: "AIzaSyCUvySwb2nW0pm8D2i70vU6_R0Z6i6gDHY",
    authDomain: "fileupload-3fd69.firebaseapp.com",
    databaseURL: "https://fileupload-3fd69-default-rtdb.firebaseio.com",
    projectId: "fileupload-3fd69",
    storageBucket: "fileupload-3fd69.appspot.com",
    messagingSenderId: "1048191531078",
    appId: "1:1048191531078:web:427c7f65e6637d9a84b247",
    measurementId: "G-WCY0SGWCQX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Admin credentials will be checked with Firebase Authentication
  // You should create an admin user manually in Firebase Auth for this

  // UI references
  const loginArea = document.getElementById("loginArea");
  const adminEmailInput = document.getElementById("adminEmail");
  const adminPasswordInput = document.getElementById("adminPassword");
  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const loginStatus = document.getElementById("loginStatus");

  const adminArea = document.getElementById("adminArea");
  const adminLogoutBtn = document.getElementById("adminLogoutBtn");

  const usersTbody = document.getElementById("usersTbody");
  const userDetails = document.getElementById("userDetails");
  const detailEmail = document.getElementById("detailEmail");
  const detailUid = document.getElementById("detailUid");
  const detailBanInfo = document.getElementById("detailBanInfo");
  const banDurationInput = document.getElementById("banDuration");
  const banReasonInput = document.getElementById("banReason");
  const applyBanBtn = document.getElementById("applyBanBtn");
  const removeBanBtn = document.getElementById("removeBanBtn");
  const messageListDiv = document.getElementById("messageList");

  let selectedUser = null;
  let adminUser = null;

  // Utility: format timestamp to readable string
  function formatDate(timestamp) {
    const dt = new Date(timestamp);
    return dt.toLocaleString();
  }

  // Show login error or status
  function showLoginStatus(msg, isError = true) {
    loginStatus.style.color = isError ? "red" : "green";
    loginStatus.textContent = msg;
  }

  // Login as admin
  adminLoginBtn.onclick = () => {
    const email = adminEmailInput.value.trim();
    const password = adminPasswordInput.value.trim();
    if (!email || !password) {
      showLoginStatus("Please enter email and password.");
      return;
    }
    signInWithEmailAndPassword(auth, email, password)
      .then(cred => {
        adminUser = cred.user;
        showLoginStatus("Login successful.", false);
        loginArea.style.display = "none";
        adminArea.style.display = "block";
        loadUsers();
      })
      .catch(err => {
        showLoginStatus("Login failed: " + err.message);
      });
  };

  // Logout admin
  adminLogoutBtn.onclick = () => {
    signOut(auth).then(() => {
      adminUser = null;
      loginArea.style.display = "block";
      adminArea.style.display = "none";
      userDetails.hidden = true;
      usersTbody.innerHTML = "";
      messageListDiv.innerHTML = "";
      showLoginStatus("");
    });
  };

  // Check auth state, redirect UI
  onAuthStateChanged(auth, (user) => {
    if (user) {
      adminUser = user;
      loginArea.style.display = "none";
      adminArea.style.display = "block";
      loadUsers();
    } else {
      adminUser = null;
      loginArea.style.display = "block";
      adminArea.style.display = "none";
      userDetails.hidden = true;
      usersTbody.innerHTML = "";
      messageListDiv.innerHTML = "";
      showLoginStatus("");
    }
  });

  // Load all users from Firebase Authentication REST API
  // Firebase does not provide direct SDK method to list users in client apps for security
  // So here, this example assumes you have a "users" node in your Realtime Database with {uid: email} pairs
  // You must maintain this yourself, or implement a secure backend for listing users
  //
  // For demo purposes, we'll fetch from "users" node in Realtime Database
  async function loadUsers() {
    usersTbody.innerHTML = "<tr><td colspan='4'>Loading users...</td></tr>";
    try {
      const usersSnap = await get(ref(db, "users"));
      if (!usersSnap.exists()) {
        usersTbody.innerHTML = "<tr><td colspan='4'>No users found.</td></tr>";
        return;
      }
      const usersData = usersSnap.val();

      usersTbody.innerHTML = "";

      for (const uid in usersData) {
        const email = usersData[uid];
        // Check ban status for each user
        const banSnap = await get(ref(db, `bans/${uid}`));
        const banData = banSnap.exists() ? banSnap.val() : null;
        const now = Date.now();
        let banStatus = "Not banned";
        if (banData) {
          const banEnd = banData.bannedAt + banData.duration * 24 * 60 * 60 * 1000;
          if (now < banEnd) {
            banStatus = `Banned (${banData.duration} days left) Reason: ${banData.reason || "None"}`;
          } else {
            // Ban expired, remove it
            await remove(ref(db, `bans/${uid}`));
          }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${email}</td>
          <td>${uid}</td>
          <td>${banStatus}</td>
          <td>
            <button class="btn-primary btn-view" data-uid="${uid}" data-email="${email}">View Details</button>
          </td>
        `;
        usersTbody.appendChild(tr);
      }

      // Add event listeners for view buttons
      document.querySelectorAll(".btn-view").forEach(btn => {
        btn.onclick = () => {
          const uid = btn.dataset.uid;
          const email = btn.dataset.email;
          selectUser(uid, email);
        };
      });

    } catch (err) {
      usersTbody.innerHTML = `<tr><td colspan='4'>Error loading users: ${err.message}</td></tr>`;
    }
  }

  // Select user to show details and messages
  async function selectUser(uid, email) {
    selectedUser = { uid, email };
    detailEmail.textContent = email;
    detailUid.textContent = uid;

    // Load ban info
    const banSnap = await get(ref(db, `bans/${uid}`));
    const banData = banSnap.exists() ? banSnap.val() : null;
    const now = Date.now();

    if (banData) {
      const banEnd = banData.bannedAt + banData.duration * 24 * 60 * 60 * 1000;
      if (now < banEnd) {
        const daysLeft = Math.ceil((banEnd - now) / (24 * 60 * 60 * 1000));
        detailBanInfo.textContent = `Banned - ${daysLeft} day(s) left. Reason: ${banData.reason || "None"}`;
        banDurationInput.value = banData.duration;
        banReasonInput.value = banData.reason || "";
        removeBanBtn.disabled = false;
        applyBanBtn.disabled = false;
      } else {
        // Ban expired, cleanup
        await remove(ref(db, `bans/${uid}`));
        detailBanInfo.textContent = "Not banned";
        banDurationInput.value = 7;
        banReasonInput.value = "";
        removeBanBtn.disabled = true;
        applyBanBtn.disabled = false;
      }
    } else {
      detailBanInfo.textContent = "Not banned";
      banDurationInput.value = 7;
      banReasonInput.value = "";
      removeBanBtn.disabled = true;
      applyBanBtn.disabled = false;
    }

    userDetails.hidden = false;
    loadUserMessages(uid);
  }

  // Load messages sent by user
  async function loadUserMessages(uid) {
    messageListDiv.innerHTML = "Loading messages...";
    try {
      // messages are stored under "messages" node with keys, filter by sender UID
      // Since Firebase RTDB doesn't support advanced queries on multiple child fields,
      // We'll fetch all messages and filter locally (not scalable for very large data)
      const messagesSnap = await get(ref(db, "messages"));
      if (!messagesSnap.exists()) {
        messageListDiv.innerHTML = "<i>No messages from this user.</i>";
        return;
      }
      const allMessages = messagesSnap.val();
      const userMessages = Object.entries(allMessages)
        .filter(([key, msg]) => msg.uid === uid)
        .sort((a, b) => a[1].timestamp - b[1].timestamp);

      if (userMessages.length === 0) {
        messageListDiv.innerHTML = "<i>No messages from this user.</i>";
        return;
      }

      messageListDiv.innerHTML = "";
      userMessages.forEach(([msgId, msg]) => {
        const div = document.createElement("div");
        div.innerHTML = `
          <span>[${formatDate(msg.timestamp)}]</span> ${msg.text}
          <button class="btn-danger btn-delete-msg" data-msgid="${msgId}" style="float:right;">Delete</button>
        `;
        messageListDiv.appendChild(div);
      });

      // Add delete event listeners
      document.querySelectorAll(".btn-delete-msg").forEach(btn => {
        btn.onclick = async () => {
          const msgId = btn.dataset.msgid;
          if (!confirm("Delete this message?")) return;
          try {
            await remove(ref(db, `messages/${msgId}`));
            loadUserMessages(uid);
          } catch (err) {
            alert("Error deleting message: " + err.message);
          }
        };
      });

    } catch (err) {
      messageListDiv.innerHTML = `Error loading messages: ${err.message}`;
    }
  }

  // Apply ban button
  applyBanBtn.onclick = async () => {
    if (!selectedUser) return alert("Select a user first.");
    let duration = parseInt(banDurationInput.value);
    if (isNaN(duration) || duration < 1) return alert("Invalid ban duration.");
    if (duration > 365) duration = 365;
    const reason = banReasonInput.value.trim() || "No reason provided";

    const banRef = ref(db, `bans/${selectedUser.uid}`);
    const now = Date.now();
    try {
      await set(banRef, {
        bannedAt: now,
        duration,
        reason,
      });
      alert(`User ${selectedUser.email} banned for ${duration} day(s).`);
      selectUser(selectedUser.uid, selectedUser.email);
      loadUsers();
    } catch (err) {
      alert("Failed to apply ban: " + err.message);
    }
  };

  // Remove ban button
  removeBanBtn.onclick = async () => {
    if (!selectedUser) return alert("Select a user first.");
    const banRef = ref(db, `bans/${selectedUser.uid}`);
    if (!confirm(`Remove ban for user ${selectedUser.email}?`)) return;
    try {
      await remove(banRef);
      alert("Ban removed.");
      selectUser(selectedUser.uid, selectedUser.email);
      loadUsers();
    } catch (err) {
      alert("Failed to remove ban: " + err.message);
    }
  };
</script>

</body>
</html>
