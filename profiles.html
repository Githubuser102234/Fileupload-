<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Profile</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
    padding: 10px;
  }
  #profilePic {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background-color: #ccc;
    object-fit: cover;
  }
  #editBtn {
    margin-top: 15px;
    padding: 8px 15px;
    font-size: 16px;
    cursor: pointer;
  }
  #loading, #errorMsg {
    font-weight: bold;
    margin-top: 20px;
  }
  .field-label {
    font-weight: bold;
    margin-top: 10px;
  }
</style>
</head>
<body>

<h1>User Profile</h1>
<div id="loading">Loading profile...</div>
<div id="errorMsg" style="color: red;"></div>

<img id="profilePic" src="" alt="Profile Picture" style="display:none;" />
<div><span class="field-label">Username:</span> <span id="username"></span></div>
<div><span class="field-label">Nickname:</span> <span id="nickname"></span></div>
<div><span class="field-label">Bio:</span></div>
<p id="bio" style="white-space: pre-wrap;"></p>

<button id="editBtn" style="display:none;">Edit Profile</button>

<script type="module">
// Import Firebase modules (ensure you include these scripts in your real deployment or use a bundler)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

// Your Firebase config here
const firebaseConfig = {
  apiKey: "AIzaSyCUvySwb2nW0pm8D2i70vU6_R0Z6i6gDHY",
  authDomain: "fileupload-3fd69.firebaseapp.com",
  databaseURL: "https://fileupload-3fd69-default-rtdb.firebaseio.com",
  projectId: "fileupload-3fd69",
  storageBucket: "fileupload-3fd69.appspot.com",
  messagingSenderId: "1048191531078",
  appId: "1:1048191531078:web:427c7f65e6637d9a84b247",
  measurementId: "G-WCY0SGWCQX"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const loadingEl = document.getElementById("loading");
const errorEl = document.getElementById("errorMsg");
const usernameEl = document.getElementById("username");
const nicknameEl = document.getElementById("nickname");
const bioEl = document.getElementById("bio");
const profilePicEl = document.getElementById("profilePic");
const editBtn = document.getElementById("editBtn");

const profileUsername = window.location.hash.slice(1);
if (!profileUsername) {
  loadingEl.textContent = "No username provided in URL.";
} else {
  // Track current logged-in user's UID and username (we assume you store username in profile or auth)
  let currentUserUid = null;
  let currentUserName = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUserUid = user.uid;
      // Fetch current user's username from profiles path
      const userProfileRef = ref(db, "profiles/" + user.displayName || user.uid);
      onValue(userProfileRef, (snap) => {
        if (snap.exists()) {
          currentUserName = snap.val().username || user.displayName || null;
          // Now load the requested profile data
          loadProfile(profileUsername);
        } else {
          // If no profile found for logged in user, still load target profile
          loadProfile(profileUsername);
        }
      }, (err) => {
        console.error("Error fetching current user profile:", err);
        loadProfile(profileUsername);
      });
    } else {
      // Not logged in, just load profile
      loadProfile(profileUsername);
    }
  });

  function loadProfile(username) {
    const profileRef = ref(db, "profiles/" + username);
    onValue(profileRef, (snapshot) => {
      loadingEl.style.display = "none";
      errorEl.textContent = "";
      if (snapshot.exists()) {
        const profile = snapshot.val();

        usernameEl.textContent = username;
        nicknameEl.textContent = profile.nickname || "(No nickname set)";
        bioEl.textContent = profile.bio || "(No bio set)";

        if (profile.profilePictureUrl) {
          profilePicEl.src = profile.profilePictureUrl;
          profilePicEl.style.display = "block";
        } else {
          profilePicEl.style.display = "none";
        }

        // Show Edit button only if this is the logged-in user's profile
        if (currentUserUid && username === currentUserName) {
          editBtn.style.display = "inline-block";
        } else {
          editBtn.style.display = "none";
        }
      } else {
        errorEl.textContent = "Profile not found.";
        usernameEl.textContent = "";
        nicknameEl.textContent = "";
        bioEl.textContent = "";
        profilePicEl.style.display = "none";
        editBtn.style.display = "none";
      }
    }, (error) => {
      loadingEl.style.display = "none";
      console.error("Firebase read error:", error);
      errorEl.textContent = "Error loading profile: " + error.message;
    });
  }
}

// Edit button click handler (redirect to your edit profile page or open modal)
editBtn.addEventListener("click", () => {
  // Replace with your real edit profile page URL or modal logic
  alert("Edit profile feature coming soon!");
});
</script>

</body>
</html>